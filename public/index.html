<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teachable Machine Image Classifier</title>
</head>
<body>
    <div>
        Teachable Machine Image Classifier
        <input type="file" id="imageUpload" accept="image/*" />
    </div>
    <div id="resultDisplay"></div> <!-- 결과를 출력할 요소에 id 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/p5@latest/lib/p5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@latest/lib/addons/p5.dom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ml5@latest/dist/ml5.min.js"></script>

    <script type="text/javascript">
        let classifier;
        let img;
        let label = "";

        function preload() {
            classifier = ml5.imageClassifier('./my_model/model.json');
        }

        function setup() {
            createCanvas(224, 224); // 이미지 크기 조정
            let imageUpload = select('#imageUpload');
            imageUpload.changed(handleImage);
        }

        function draw() {
            background(255); // 흰 배경으로 설정
            if (img) {
                image(img, 0, 0, width, height);
            }
            fill(0);
        }

        function handleImage() {
            img = loadImage(URL.createObjectURL(select('#imageUpload').elt.files[0]), classifyImage);
        }

        function classifyImage() {
            if (img) {
                // 이미지 크기를 모델의 기대 크기로 조정
                img.resize(224, 224);
                classifier.classify(img, gotResult);
            }
        }

        function sendImageToServer(img) {
            // 이미지 데이터를 base64로 인코딩
            const dataUrl = canvas.toDataURL();
            const base64Img = dataUrl.split(',')[1];

            // 이미지 데이터를 서버로 전송
            const formData = new FormData();
            formData.append('image', base64toBlob(base64Img), 'image.png');

            fetch('http://localhost:5000/classify', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log(data.result);
                // 여기서 결과를 사용하거나 표시할 수 있습니다.
                select('#resultDisplay').html(`Result from Server: ${data.result}`);
            })
            .catch(error => console.error('Error:', error));
        }

        function gotResult(error, results) {
            if (error) {
                console.error(error);
                return;
            }

            console.log(results);
            label = results[0].label;
            confidence = results[0].confidence;

            // 결과를 id가 'resultDisplay'인 요소에 출력
            select('#resultDisplay').html(`Label: ${label}<br>Confidence: ${nf(confidence * 100, 0, 2)}%`);
            
            // 서버로 이미지 전송
            sendImageToServer(img);
        }

        // base64를 Blob으로 변환하는 함수
        function base64toBlob(base64) {
            const binary = atob(base64);
            const array = [];
            for (let i = 0; i < binary.length; i++) {
                array.push(binary.charCodeAt(i));
            }
            return new Blob([new Uint8Array(array)], { type: 'image/png' });
        }
    </script>
</body>
</html>

