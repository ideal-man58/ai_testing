<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teachable Machine Image Classifier</title>
</head>
<body>
    <div>
        Teachable Machine Image Classifier
        <!-- 이미지 업로드를 위한 버튼 -->
        <input type="file" id="imageUpload" accept="image/*" onchange="handleImage()">
    </div>
    <div id="resultDisplay"></div> <!-- 결과를 출력할 요소에 id 추가 -->
    <button onclick="postResult()">Post Result</button> <!-- 결과를 서버로 POST하는 버튼 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/p5@latest/lib/p5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@latest/lib/addons/p5.dom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ml5@latest/dist/ml5.min.js"></script>

    <script type="text/javascript">
        let classifier;
        let imageModelURL = 'https://teachablemachine.withgoogle.com/models/EPOb0BwIo/';
        let img;
        let label = "";

        function preload() {
            classifier = ml5.imageClassifier(imageModelURL + 'model.json');
        }

        function setup() {
            createCanvas(224, 224); // 이미지 크기 조정
        }

        function draw() {
            background(255); // 흰 배경으로 설정
            if (img) {
                image(img, 0, 0, width, height);
            }
            fill(0);
        }

        // 이미지 업로드 및 분류 이벤트 핸들러
        function handleImage() {
            let fileInput = document.getElementById('imageUpload');
            let file = fileInput.files[0];
            
            if (file) {
                img = loadImage(URL.createObjectURL(file), classifyImage);
            } else {
                console.error('No file selected');
            }
        }

        function classifyImage() {
            if (img) {
                // 이미지 크기를 모델의 기대 크기로 조정
                img.resize(224, 224);
                classifier.classify(img, gotResult);
            }
        }

        function gotResult(error, results) {
            if (error) {
                console.error(error);
                return;
            }

            console.log(results);
            label = results[0].label;
            confidence = results[0].confidence;

            // 결과를 id가 'resultDisplay'인 요소에 출력
            document.getElementById('resultDisplay').innerHTML = `Label: ${label}<br>Confidence: ${nf(confidence * 100, 0, 2)}%`;
        }

        // 결과를 서버로 POST하는 함수
        function postResult() {
            // 결과 데이터
            let resultData = {
                label: label,
                confidence: confidence
            };

            // fetch를 사용하여 서버로 POST 요청
            fetch('/post-result', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(resultData),
            })
            .then(response => response.json())
            .then(data => {
                console.log('Server Response:', data);
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    </script>
</body>
</html>
